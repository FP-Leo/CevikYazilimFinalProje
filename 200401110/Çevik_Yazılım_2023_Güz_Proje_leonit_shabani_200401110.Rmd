---
title: "Proje Rapor : Leonit Shabani 200401110"
output:
  html_document:
    df_print: paged
---

# Q1 : Problem tanımı

Şirketimiz, müşterilere film ve TV şovlarını yayınlamak için bir TV kanalı açmak isteyenlere yönelik yayın planları satmaktadır. Daha fazla müşteri çekmek için algoritmamızı geliştirmemiz gerekiyor.

# Q2 : Proje Amacı

[Netflix Engagement (Jan - Jun 23) +](https://www.kaggle.com/datasets/vassyesboy/netflix-engagement-jan-jun-23) adli Kaggle veri setini kullanarak her kategorinin en iyi şovlarını bulacak ve bunlara dayanarak müşterilerimizin isteklerine uygun en iyi listeyi öneren yeni bir algoritma geliştirmeyi amaçlıyoruz. Doğru algoritmayı geliştirdikten ve doğru pazarlamayı yaptıktan sonra, şirketimizdeki trafiğin en az %25 artacağını tahmin ediyoruz.

# Q3 : Veri seti keşifsel analizi

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Kodun çalışması için gereken kütüphaneleri yükle

library(tidyr)
library(dplyr)
library(readr)
library(stringr)

# Veri dosyasını internetten indir ve git repo'sunun içine commitle
filename <- "Netflix Engagement (plus).csv"

# Dosyayi ithal et
myDF <- read_csv(filename)
```
Veri seti Kaggle web sitesinden indirilmiştir ve **readr::read_csv()** fonksiyonu kullanılarak **`r class(myDF)[[1]]`** tipinde bir değişkene ithal edilmiştir. Veri boyutları aşağıdaki gibidir :

- Satır sayısı : `r nrow(myDF)`
- Sütün sayısı : `r ncol(myDF)`

Veri setinin ön görsellemesi aşağıda verilmiştir.

```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF <- myDF %>% distinct()
myDF
```

Veri setini incelediğimizde, **Hours Viewed, Number of Ratings, Rating** sütunlarının bizim için uygun olan dbl türünde olduğunu görüyoruz çünkü bunları hesaplamalar için kullanacağız. **Release Date** sütunu date türündedir ve **Title, Available Globally?, Genre, Key Words, Description** sütunları tümüyle char türündedir. Hesaplamalar için **Available Globally?** sütununu, sonuç için **Title** sütununu ve **Genre** sütununu türüne göre ayrı veri kümelerine ayırmak için kullanacağız. **Key Words** sütununu kullanmayacağız çünkü orada yararlı bir bilgi yok.

Aşağıdaki histogramda yıllara göre yayınlanan filmlerin/dizilerin dağılımı gösterilmektedir.
```{r echo=FALSE, message=FALSE, warning=FALSE}
barplot(table(na.omit(format(as.Date(myDF$`Release Date`), "%Y"))), main = "Number of Releases by Year", xlab = "Year", ylab = "Number of Releases", col = "blue")
```

Görüldüğü üzere verilerin büyük çoğunluğu 2022’den gelmektedir, bu Netflix’in Avrupa genelinde [tartışmalı kotaları](https://www.theparliamentmagazine.eu/news/article/eu-quotas-for-netflix-widely-criticised#:~:text=On%2Ddemand%20digital%20services%20like,should%20be%20made%20in%20Europe.&text=The%20European%20Commission%20has%20also,be%20given%20%22good%20visibility%22.) karşılamak için birçok belgesel, film ve dizi satın aldığından dolayıdır. 2023 verileri, sadece 2023 Haziran ayına kadar olan yayın sayısını içerdiği için eksiktir.

```{r echo=FALSE, message=FALSE, warning=FALSE}
barplot(table(na.omit(format(as.Date(subset(myDF, format(as.Date(`Release Date`), "%Y") == "2023")$`Release Date`), "%m"))), main = "2023 Statistics - Number of Releases by Month so far", xlab = "Month", ylab = "Number of Releases", col = "blue", ylim = c(0, 100), axes = FALSE)
axis(side = 2, at = seq(0, 100, by = 10), las = 1)
```

Yukarıdaki grafik, 2023 yılına kadar aylık olarak yapılan yayınların sayısını göstermektedir. Bu durumdan, Netflix'in 2023 yılında sürekli olarak tutarlı bir içerik sunduğu sonucuna varabiliriz.

## İzlenen Saatlerin Ortamaları
```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF %>%
  mutate(Year = format(as.Date(`Release Date`), "%Y")) %>%
  filter(Year %in% c("2021", "2022", "2023")) %>%
  group_by(Year) %>%
  summarise(`Average Watch Time` = mean(`Hours Viewed`, na.rm = TRUE))
```

İstatistiklere göre, Netflix izleyici sayısı 2023'ün sadece ilk 6 ayında, izlenen saatler açısından 2022'ye kıyasla neredeyse dört katına çıkmıştır.

# Q4 : Veri seti ön işlemesi

## Genre Sütunu
```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF$Genre <- gsub("\\[|\\'|\\]", "", myDF$Genre)
```
**Genre** sütunu yeniden biçimlendirildi.
```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF <- myDF %>%
  mutate(Genre = replace_na(Genre, "Unknown"))
myDF$Genres <- myDF$Genre
```
Yok Değerler **Genre** sütunundan değiştirildi.
```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF <- separate_rows(myDF, 'Genre', sep = ", ")
```
**Genre** sütunu bölündü.

## Key Words Sütunu
```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF <- myDF[, -8]
```
**Key Words** Sütunu kaldırıldı.

## Description Sütunu
```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF <- myDF[, -8]
```
**Description** Sütunu kaldırıldı.

## Year Sütunu
```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF$Year <- format(as.Date(myDF$`Release Date`), "%Y")
myDF$Year <- as.numeric(myDF$Year)
```
**Year** Sütunu oluşturuldu.

## Month Sütunu
```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF$Month <- format(as.Date(myDF$`Release Date`), "%m")
myDF$Month <- as.numeric(myDF$Month)
```
**Month** Sütunu oluşturuldu.

# Q5 : Veri mühendisliği 

```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF$Quartet <- (myDF$Month-1)%/%3 + 1
```
Daha iyi temsil için verileri çeyreklere göre gruplandırıldı.

```{r echo=FALSE, message=FALSE, warning=FALSE}
df_quartet <- myDF %>%
  select(`Hours Viewed`, `Year`, `Quartet`) %>%
  na.omit() %>%
  group_by(Year, Quartet) %>%
  summarise(avg_hours_watched = mean(`Hours Viewed`)) %>%
  arrange(Year, Quartet)

df_quartet <- df_quartet[!grepl("2010|2011|2012|2023", df_quartet$Year), ]

colors <- rainbow(length(unique(df_quartet$Year)))
df_quartet$Year <- as.factor(df_quartet$Year)
color_mapping <- colors[df_quartet$Year]
barplot(df_quartet$avg_hours_watched, 
        main="Average Hours Watched per Quartet", 
        xlab="Quartet", 
        ylab="Average Hours Watched",
        names.arg=df_quartet$Year,
        col=color_mapping)
```

Yukarıdaki grafik, 2013'ten 2022'ye kadar her çeyrekteki ortalama izlenme saatlerini göstermektedir.

```{r echo=FALSE, message=FALSE, warning=FALSE}
df_releases <- myDF %>%
  select(`Year`, `Quartet`) %>%
  na.omit() %>%
  group_by(Year, Quartet) %>%
  summarise(releases = n()) %>%
  arrange(Year, Quartet)
df_releases <- df_releases[!grepl("2010|2011|2012|2023", df_releases$Year), ]
barplot(df_releases$releases, 
        main="Releases per Quartet", 
        xlab="Quartet", 
        ylab="Releases",
        names.arg=df_releases$Year,
        col=color_mapping)
```

Yukarıdaki grafik, 2013'ten 2022'ye kadar her çeyrekteki sürüm sayısını göstermektedir. Görüldüğü gibi 4. çeyrekte sürüm sayısı her zaman daha yüksektir. Saatlik görüntülemelerin hangi çeyrekte daha yüksek olduğu sonucuna varmak için yeterli veri yok.

# Q6 : Veri analizi 

```{r echo=FALSE, message=FALSE, warning=FALSE}
genreStats <- myDF %>%
  group_by(Genre) %>%
  summarise(avg_watch_time = mean(`Hours Viewed`, na.rm = TRUE)) %>%
  na.omit() %>%
  arrange(avg_watch_time)
par(mar=c(5,6,0,0) + 2)
par(mgp=c(6,1,0))
barplot(genreStats$avg_watch_time, 
        main="Average Watch Time per Genre", 
        xlab="Genre", 
        ylab="Average Watch Time",
        names.arg=genreStats$Genre,
        las=2,
        col = "blue")
par(mgp=c(3,1,0))
par(mar=c(5,4,4,2) + 0.1) 
```

Türlerine göre gruplandırarak ve İzlenen Saatlerin ortalamasını alarak, en çok izlenen türleri gruplayilabilir ve final formülü geliştirilebilirdir.


```{r echo=FALSE, message=FALSE, warning=FALSE}
myDF <- myDF %>%
  select(-Genre)  %>%
  distinct()
```
## Sütun ortamaları
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Average Hours Viewed
HVavg <- mean(myDF$`Hours Viewed`, na.rm = TRUE)
#Average Reviews Gotten
NRavg <- mean(myDF$`Number of Ratings`, na.rm = TRUE)
#Average Rating
Ravg <- mean(myDF$`Rating`, na.rm = TRUE)
data.frame(
  `Average Hours Viewed` = HVavg,
  `Average Number of Ratings` = NRavg,
  `Average Rating` = Ravg
)
```
Yukarıdaki tablo söz konusu üç sütunun ortalamalarını göstermektedir.

```{r echo=FALSE, message=FALSE, warning=FALSE}
genreRanking <- 1:nrow(genreStats)
names(genreRanking) <- genreStats$Genre
genreRanking["Unknown"] <- 0
```

```{r echo=FALSE, message=FALSE, warning=FALSE}

testDF <- myDF %>%
  separate(Genres, into = paste0("Genre ", seq_len(max(str_count(myDF$Genres, ",")) + 1)), sep = ",", remove = TRUE, convert = TRUE)%>%
  select(Title, `Genre 1`, `Genre 2`, `Genre 3`)
testDF$`Genre 1` <- sapply(testDF$`Genre 1`, function(x) if(is.character(x)) gsub("\\s", "", x) else x)
testDF$`Genre 2` <- sapply(testDF$`Genre 2`, function(x) if(is.character(x)) gsub("\\s", "", x) else x)
testDF$`Genre 3` <- sapply(testDF$`Genre 3`, function(x) if(is.character(x)) gsub("\\s", "", x) else x)
testDF <- testDF %>% 
  mutate(`Genre 1` = replace_na(`Genre 1`, "Unknown"))%>% 
  mutate(`Genre 2` = replace_na(`Genre 2`, "Unknown"))%>%
  mutate(`Genre 3` = replace_na(`Genre 3`, "Unknown"))%>%
  mutate(`Genre Value` = genreRanking[`Genre 1`] + genreRanking[`Genre 2`] + genreRanking[`Genre 3`])
testDF <- testDF %>% select(Title, `Genre Value`)
myDF <- distinct(myDF, Title, .keep_all = TRUE)
testDF <- distinct(testDF, Title, .keep_all = TRUE)
myDF <- inner_join(myDF, testDF, by = "Title")
```
## Sonuç
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Her sütuna belirli bir değer veriyoruz. Eğer global olarak kullanılabilir değilse, ekstra puan verme kararı aldık çünkü eğer öyle olsaydı ekstra görüntü alırdı. Her kategoride ortalamanın üzerinde olanlar için ekstra puan alır. Her tür için tür sıralamasına dayalı olarak puan alır. Ne kadar yeni olursa, o kadar çok puan alır.

myDF <- myDF %>% mutate(`Final Result` = `Genre Value` * 7 + 
                          ifelse(is.na(`Quartet`), 0, `Quartet` * 3) + 
                          ifelse(is.na(`Year`), 0, `Year` * 2) +
                          ifelse(is.na(`Hours Viewed`) | `Hours Viewed` < HVavg, 0, (`Hours Viewed`-HVavg)*0.00001) +
                          ifelse(is.na(`Number of Ratings`) | `Number of Ratings` < NRavg, 0, (`Number of Ratings`-NRavg)*0.01) +
                          ifelse(is.na(`Rating`) | `Rating` < Ravg, 0, (`Rating`-Ravg)*100) +
                          ifelse(is.na(`Available Globally?`) | `Available Globally?` == 'Yes', 0, 100))
myDF <- myDF %>% select(Title, `Available Globally?`, `Release Date`, `Hours Viewed`, `Number of Ratings`, `Rating`, `Genres`, `Final Result`) %>% arrange(desc(`Final Result`))
myDF
```

Yukarıdaki tablo, en iyi derecelendirilmiş filmleri/dizi programlarını seçen yeni algoritmanın sonuçlarını göstermektedir.
